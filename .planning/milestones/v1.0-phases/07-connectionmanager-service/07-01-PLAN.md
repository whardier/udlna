---
phase: 07-connectionmanager-service
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/mime.rs
  - src/http/soap.rs
  - src/cms/mod.rs
  - src/http/mod.rs
  - src/main.rs
autonomous: true
requirements:
  - CONN-01
  - CONN-02
  - CONN-03

must_haves:
  truths:
    - "A SOAP POST to /cms/control with GetProtocolInfo returns HTTP 200 with correct CMS namespace and a Source field listing all supported video/audio/image MIME types as http-get:*:{mime}:* entries"
    - "A SOAP POST to /cms/control with GetCurrentConnectionIDs returns HTTP 200 with <ConnectionIDs>0</ConnectionIDs>"
    - "A SOAP POST to /cms/control with GetCurrentConnectionInfo returns HTTP 200 with all seven fields: RcsID=-1, AVTransportID=-1, ProtocolInfo empty, PeerConnectionManager empty, PeerConnectionID=-1, Direction=Output, Status=OK"
    - "An unknown SOAP action to /cms/control returns a SOAP fault with errorCode 401"
    - "The SOAP response envelope for CMS actions uses urn:schemas-upnp-org:service:ConnectionManager:1 namespace (not CDS namespace)"
  artifacts:
    - path: "src/cms/mod.rs"
      provides: "CMS control handler with action dispatch and three action handlers"
      min_lines: 50
    - path: "src/media/mime.rs"
      provides: "SUPPORTED_MIMES const listing all video/audio/image MIME types"
      contains: "pub const SUPPORTED_MIMES"
    - path: "src/http/soap.rs"
      provides: "soap_response_ns() and CMS_NAMESPACE constant"
      contains: "CMS_NAMESPACE"
  key_links:
    - from: "src/cms/mod.rs"
      to: "src/http/soap.rs"
      via: "soap_response_ns() with CMS_NAMESPACE"
      pattern: "soap_response_ns.*CMS_NAMESPACE"
    - from: "src/cms/mod.rs"
      to: "src/media/mime.rs"
      via: "SUPPORTED_MIMES const for GetProtocolInfo Source field"
      pattern: "SUPPORTED_MIMES"
    - from: "src/http/mod.rs"
      to: "src/cms/mod.rs"
      via: "crate::cms::cms_control replacing 501 stub"
      pattern: "crate::cms::cms_control"
---

<objective>
Replace the existing 501 stub at /cms/control with a real ConnectionManager Service (CMS) handler implementing GetProtocolInfo, GetCurrentConnectionIDs, and GetCurrentConnectionInfo SOAP actions.

Purpose: Xbox Series X and other strict DLNA clients require a working ConnectionManager before they will browse or stream. The route and SCPD XML already exist from Phase 4; this phase wires up real handlers.

Output: src/cms/mod.rs (CMS handler), SUPPORTED_MIMES in mime.rs, soap_response_ns() in soap.rs, router update in mod.rs, mod cms; in main.rs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-connectionmanager-service/07-CONTEXT.md
@.planning/phases/07-connectionmanager-service/07-RESEARCH.md

# Prior phase patterns
@.planning/phases/05-contentdirectory-service/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SUPPORTED_MIMES to mime.rs and soap_response_ns() to soap.rs</name>
  <files>src/media/mime.rs, src/http/soap.rs</files>
  <action>
**src/media/mime.rs** — add after the existing imports/constants (before or after `classify()`):

```rust
/// All MIME types this server can serve. Used by CMS GetProtocolInfo.
/// Only video, audio, and image types — subtitle types (text/srt, text/vtt)
/// are intentionally excluded per DLNA ConnectionManager spec.
pub const SUPPORTED_MIMES: &[&str] = &[
    // Video
    "video/mp4",
    "video/x-matroska",
    "video/x-msvideo",
    "video/quicktime",
    "video/MP2T",
    "video/mpeg",
    "video/x-ms-wmv",
    "video/x-flv",
    "video/ogg",
    "video/webm",
    "video/3gpp",
    // Audio
    "audio/mpeg",
    "audio/flac",
    "audio/wav",
    "audio/mp4",
    "audio/aac",
    "audio/ogg",
    "audio/x-ms-wma",
    "audio/aiff",
    // Image
    "image/jpeg",
    "image/png",
    "image/gif",
    "image/webp",
    "image/bmp",
    "image/tiff",
];
```

Verify the list mirrors all MIME strings returned by `classify()` for Video/Audio/Image kinds. Cross-check by reading the existing match arms in `classify()`. Do NOT include "text/srt" or "text/vtt".

**src/http/soap.rs** — add after the existing `CDS_NAMESPACE` constant:

```rust
pub const CMS_NAMESPACE: &str = "urn:schemas-upnp-org:service:ConnectionManager:1";
```

Add `soap_response_ns()` after the existing `soap_response()` function body (replace `soap_response()` to delegate — keep backwards compatibility):

```rust
/// Build a SOAP 1.1 response envelope with an explicit service namespace.
/// Used by CMS and any future UPnP service with a different namespace.
pub fn soap_response_ns(action: &str, inner_xml: &str, namespace: &str) -> String {
    format!(
        r#"<?xml version="1.0" encoding="utf-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"
            s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <s:Body>
    <u:{action}Response xmlns:u="{ns}">
      {inner_xml}
    </u:{action}Response>
  </s:Body>
</s:Envelope>"#,
        action = action,
        ns = namespace,
        inner_xml = inner_xml,
    )
}
```

Update the existing `soap_response()` to delegate to `soap_response_ns()` (backwards-compatible refactor):

```rust
pub fn soap_response(action: &str, inner_xml: &str) -> String {
    soap_response_ns(action, inner_xml, CDS_NAMESPACE)
}
```

Run `cargo build` — must compile clean with no warnings added.
  </action>
  <verify>cargo build 2>&amp;1 | grep -E "^error" | wc -l | tr -d ' ' (must be 0); grep "pub const SUPPORTED_MIMES" src/media/mime.rs; grep "pub const CMS_NAMESPACE" src/http/soap.rs; grep "soap_response_ns" src/http/soap.rs</verify>
  <done>cargo build succeeds; SUPPORTED_MIMES const exists in mime.rs with no subtitle MIME types; CMS_NAMESPACE and soap_response_ns() exist in soap.rs; existing soap_response() delegates to soap_response_ns().</done>
</task>

<task type="auto">
  <name>Task 2: Create src/cms/mod.rs and wire into router and main.rs</name>
  <files>src/cms/mod.rs, src/http/mod.rs, src/main.rs</files>
  <action>
**Create src/cms/mod.rs** — new file. Pattern mirrors src/http/content_directory.rs.

```rust
use axum::{
    extract::State,
    http::{header, HeaderMap, StatusCode},
    response::{IntoResponse, Response},
};
use crate::http::soap::{soap_response_ns, soap_fault, CMS_NAMESPACE};
use crate::http::state::AppState;
use crate::media::mime::SUPPORTED_MIMES;

fn ok_xml(body: String) -> Response {
    (
        StatusCode::OK,
        [(header::CONTENT_TYPE, "text/xml; charset=\"utf-8\"")],
        body,
    )
        .into_response()
}

pub async fn cms_control(
    State(_state): State<AppState>,
    headers: HeaderMap,
    body: String,
) -> Response {
    let action = headers
        .get("soapaction")
        .and_then(|v| v.to_str().ok())
        .and_then(|s| s.split('#').nth(1))
        .map(|s| s.trim_matches('"').to_string());

    match action.as_deref() {
        Some("GetProtocolInfo") => handle_get_protocol_info(),
        Some("GetCurrentConnectionIDs") => handle_get_current_connection_ids(),
        Some("GetCurrentConnectionInfo") => handle_get_current_connection_info(),
        _ => {
            tracing::warn!("Unknown CMS action: {:?}", action);
            // UPnP 1.0 error 401 = Invalid Action (not 402 InvalidArgs)
            soap_fault(401, "Invalid Action").into_response()
        }
    }
}

fn handle_get_protocol_info() -> Response {
    let source: String = SUPPORTED_MIMES
        .iter()
        .map(|mime| format!("http-get:*:{}:*", mime))
        .collect::<Vec<_>>()
        .join(",");
    let inner = format!("<Source>{}</Source><Sink></Sink>", source);
    ok_xml(soap_response_ns("GetProtocolInfo", &inner, CMS_NAMESPACE))
}

fn handle_get_current_connection_ids() -> Response {
    ok_xml(soap_response_ns(
        "GetCurrentConnectionIDs",
        "<ConnectionIDs>0</ConnectionIDs>",
        CMS_NAMESPACE,
    ))
}

fn handle_get_current_connection_info() -> Response {
    let inner = concat!(
        "<RcsID>-1</RcsID>",
        "<AVTransportID>-1</AVTransportID>",
        "<ProtocolInfo></ProtocolInfo>",
        "<PeerConnectionManager></PeerConnectionManager>",
        "<PeerConnectionID>-1</PeerConnectionID>",
        "<Direction>Output</Direction>",
        "<Status>OK</Status>",
    );
    ok_xml(soap_response_ns(
        "GetCurrentConnectionInfo",
        inner,
        CMS_NAMESPACE,
    ))
}
```

Notes:
- `State(_state)` uses underscore prefix since CMS actions do not need library access (SUPPORTED_MIMES is a const)
- Error code 401 for unknown action per UPnP 1.0 spec (NOT 402 which is InvalidArgs — copy-paste pitfall from CDS)
- Status="OK" per CONTEXT.md locked decision (minidlna uses "Unknown" but CONTEXT.md overrides this)
- Field order in GetCurrentConnectionInfo matches CMS SCPD argument list in description.rs

**src/http/mod.rs** — replace the existing `/cms/control` 501 inline stub:

Find:
```rust
.route("/cms/control", axum::routing::post(|| async {
    (axum::http::StatusCode::NOT_IMPLEMENTED, "Not Implemented")
}))
```

Replace with:
```rust
.route("/cms/control", axum::routing::post(crate::cms::cms_control))
```

**src/main.rs** — add `mod cms;` alongside other module declarations (after existing mod declarations, before use statements or fn main). Verify it compiles and the new module is included.

Run `cargo build` — must compile clean.
  </action>
  <verify>cargo build 2>&amp;1 | grep -E "^error" | wc -l | tr -d ' ' (must be 0); ls src/cms/mod.rs; grep "mod cms" src/main.rs; grep "crate::cms::cms_control" src/http/mod.rs</verify>
  <done>src/cms/mod.rs exists; mod cms; present in main.rs; router uses crate::cms::cms_control for /cms/control; cargo build succeeds cleanly.</done>
</task>

<task type="auto">
  <name>Task 3: Verify all three CMS SOAP actions with curl</name>
  <files></files>
  <action>
Start the server in the background (requires a media directory with at least one file):

```bash
cargo build --release 2>&amp;1 | tail -3
# Start server in background with test media directory
RUST_LOG=warn ./target/release/udlna /tmp/test-media &amp;
SERVER_PID=$!
sleep 1
```

Run three curl SOAP verifications. Create SOAP bodies inline:

**Test 1 — GetProtocolInfo (CONN-01):**
```bash
curl -s -X POST http://localhost:8200/cms/control \
  -H 'Content-Type: text/xml; charset="utf-8"' \
  -H 'SOAPAction: "urn:schemas-upnp-org:service:ConnectionManager:1#GetProtocolInfo"' \
  -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetProtocolInfo xmlns:u="urn:schemas-upnp-org:service:ConnectionManager:1"></u:GetProtocolInfo></s:Body></s:Envelope>'
```
Expected: HTTP 200, body contains `GetProtocolInfoResponse`, `<Source>`, `http-get:*:video/mp4:*`, `ConnectionManager:1` namespace, `<Sink></Sink>`.

**Test 2 — GetCurrentConnectionIDs (CONN-02):**
```bash
curl -s -X POST http://localhost:8200/cms/control \
  -H 'Content-Type: text/xml; charset="utf-8"' \
  -H 'SOAPAction: "urn:schemas-upnp-org:service:ConnectionManager:1#GetCurrentConnectionIDs"' \
  -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetCurrentConnectionIDs xmlns:u="urn:schemas-upnp-org:service:ConnectionManager:1"></u:GetCurrentConnectionIDs></s:Body></s:Envelope>'
```
Expected: HTTP 200, body contains `<ConnectionIDs>0</ConnectionIDs>`.

**Test 3 — GetCurrentConnectionInfo (CONN-03):**
```bash
curl -s -X POST http://localhost:8200/cms/control \
  -H 'Content-Type: text/xml; charset="utf-8"' \
  -H 'SOAPAction: "urn:schemas-upnp-org:service:ConnectionManager:1#GetCurrentConnectionInfo"' \
  -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetCurrentConnectionInfo xmlns:u="urn:schemas-upnp-org:service:ConnectionManager:1"></u:GetCurrentConnectionInfo></s:Body></s:Envelope>'
```
Expected: HTTP 200, body contains `<RcsID>-1</RcsID>`, `<AVTransportID>-1</AVTransportID>`, `<Status>OK</Status>`, `<Direction>Output</Direction>`.

**Test 4 — Unknown action returns 401 fault:**
```bash
curl -s -X POST http://localhost:8200/cms/control \
  -H 'Content-Type: text/xml; charset="utf-8"' \
  -H 'SOAPAction: "urn:schemas-upnp-org:service:ConnectionManager:1#UnknownAction"' \
  -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body></s:Body></s:Envelope>'
```
Expected: body contains `<errorCode>401</errorCode>`.

**Cleanup:**
```bash
kill $SERVER_PID 2>/dev/null || true
```

Also run the full test suite to confirm no regressions:
```bash
cargo test 2>&amp;1 | tail -5
```

If the server requires media files, create a minimal test file:
```bash
mkdir -p /tmp/test-media
# Copy any real media file or create a placeholder that passes scan
# (server exits if zero media found — use a real audio/video/image file)
```

If no media is available in the test environment, use a system audio file or image. On macOS: `cp /System/Library/Sounds/Ping.aiff /tmp/test-media/` or `cp /Library/Desktop\ Pictures/Sonoma.heic /tmp/test-media/test.jpg 2>/dev/null`.
  </action>
  <verify>All four curl tests return expected responses; cargo test shows all tests passing (no regressions); no "text/srt" appears in GetProtocolInfo Source output; "ConnectionManager:1" namespace present in all CMS SOAP responses.</verify>
  <done>GetProtocolInfo returns Source with all video/audio/image MIME types as http-get:*:{mime}:* entries; GetCurrentConnectionIDs returns ConnectionIDs=0; GetCurrentConnectionInfo returns all seven fields with Status=OK; unknown action returns errorCode 401; all cargo tests pass.</done>
</task>

</tasks>

<verification>
1. `cargo test` — all existing tests pass, no regressions
2. `grep -r "text/srt\|text/vtt" src/cms/` — must return empty (no subtitle MIMEs in CMS)
3. `grep "soap_response_ns" src/http/soap.rs` — function exists
4. `grep "CMS_NAMESPACE" src/http/soap.rs` — constant exists
5. `grep "crate::cms::cms_control" src/http/mod.rs` — router wired correctly
6. `grep "mod cms" src/main.rs` — module declared
7. curl GetProtocolInfo → HTTP 200 with ConnectionManager:1 namespace and Source field
8. curl GetCurrentConnectionIDs → HTTP 200 with ConnectionIDs=0
9. curl GetCurrentConnectionInfo → HTTP 200 with Status=OK (not "Unknown")
</verification>

<success_criteria>
- /cms/control responds to all three CMS SOAP actions with correct HTTP 200 and spec-compliant SOAP bodies
- GetProtocolInfo Source field includes all video/audio/image MIME types in http-get:*:{mime}:* format, with no subtitle types
- SOAP response envelopes use urn:schemas-upnp-org:service:ConnectionManager:1 namespace (not CDS namespace)
- GetCurrentConnectionInfo Status field is "OK" (matching CONTEXT.md locked decision)
- Unknown CMS action returns SOAP fault with errorCode 401
- All existing cargo tests pass (no regressions)
- soap_response() still works for CDS (delegates to soap_response_ns) — no CDS regression
</success_criteria>

<output>
After completion, create `.planning/phases/07-connectionmanager-service/07-01-SUMMARY.md`
</output>
