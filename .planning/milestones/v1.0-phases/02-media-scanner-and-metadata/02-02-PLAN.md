---
phase: 02-media-scanner-and-metadata
plan: "02"
type: tdd
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/media/metadata.rs
autonomous: true
requirements:
  - INDX-02
  - INDX-03
  - INDX-04

must_haves:
  truths:
    - "format_upnp_duration() produces correct HH:MM:SS.mmm strings for all edge cases"
    - "dlna_profile_for() returns the correct static profile string for known MIME types and None for unknown"
    - "build_machine_namespace() returns a deterministic Uuid derived from machine ID"
    - "All pure functions are tested with at least one failing test before implementation (RED phase)"
  artifacts:
    - path: "src/media/metadata.rs"
      provides: "format_upnp_duration, dlna_profile_for, build_machine_namespace, media_item_id"
      contains: "pub fn format_upnp_duration"
  key_links:
    - from: "src/media/metadata.rs"
      to: "uuid crate"
      via: "Uuid::new_v5 for ID generation"
      pattern: "Uuid::new_v5"
    - from: "src/media/metadata.rs"
      to: "machine-uid crate"
      via: "machine_uid::get() for namespace seed"
      pattern: "machine_uid"
---

<objective>
Implement the pure, testable functions in metadata.rs using TDD: UPnP duration formatting, DLNA profile lookup table, and UUIDv5 ID generation helpers.

Purpose: These pure functions have defined I/O contracts that can be verified before any file I/O code is written. TDD here catches off-by-one errors in duration formatting and incorrect profile strings before they produce silent DLNA failures on real devices.
Output: src/media/metadata.rs with format_upnp_duration, dlna_profile_for, build_machine_namespace, and media_item_id — all covered by tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-media-scanner-and-metadata/02-CONTEXT.md
@.planning/phases/02-media-scanner-and-metadata/02-RESEARCH.md
@.planning/phases/02-media-scanner-and-metadata/02-01-SUMMARY.md
</context>

<feature>
  <name>Pure metadata helper functions in src/media/metadata.rs</name>
  <files>src/media/metadata.rs</files>
  <behavior>
    Functions and their contracts:

    **format_upnp_duration(total_seconds: u64, frac: f64) -> String**
    - Input: (0, 0.0) -> "00:00:00.000"
    - Input: (60, 0.0) -> "00:01:00.000"
    - Input: (3661, 0.5) -> "01:01:01.500"
    - Input: (272, 0.841) -> "00:04:32.841"  (4 min 32.841 sec)
    - Input: (5025, 0.0) -> "01:23:45.000"
    - Input: (0, 0.999) -> "00:00:00.999"
    - Input: (3600 * 99 + 59 * 60 + 59, 0.999) -> "99:59:59.999" (max realistic)
    - Rule: hours field is zero-padded to at least 2 digits (use {:02} format)
    - Rule: ms is rounded from frac*1000, cast to u32 (frac=0.9995 -> 1000 is acceptable edge case)

    **dlna_profile_for(mime: &str) -> Option<&'static str>**
    - "audio/mpeg" -> Some("MP3")
    - "audio/mp4" -> Some("AAC_ISO_320")
    - "audio/ogg" -> None
    - "audio/flac" -> None
    - "audio/wav" -> None
    - "audio/x-ms-wma" -> None
    - "video/mp4" -> None  (deferred to Phase 5 per RESEARCH.md recommendation)
    - "video/x-matroska" -> None
    - "video/x-msvideo" -> None
    - "video/MP2T" -> None
    - "image/jpeg" -> Some("JPEG_LRG")
    - "image/png" -> Some("PNG_LRG")
    - "image/gif" -> None
    - "application/unknown" -> None
    - Unknown/arbitrary string -> None (no panic, just None)

    **build_machine_namespace() -> Uuid**
    - Returns a Uuid (non-nil)
    - Calling it twice on the same machine returns the same value (deterministic)
    - Accepts fallback to "unknown" string if machine_uid::get() fails (per RESEARCH.md Pattern 6)

    **media_item_id(namespace: &Uuid, canonical_path: &Path) -> Uuid**
    - Returns a Uuid (non-nil)
    - Same namespace + same path -> same Uuid (deterministic)
    - Different paths -> different Uuids
    - Uses canonical_path.as_os_str().as_encoded_bytes() for hashing (RESEARCH.md Pattern 6)
  </behavior>
  <implementation>
    Create `src/media/metadata.rs` with `#[cfg(test)]` module at bottom. Follow strict RED-GREEN-REFACTOR:

    RED phase: Write all test cases for format_upnp_duration and dlna_profile_for first. Use stub implementations that return wrong values (e.g., format_upnp_duration always returns "". dlna_profile_for always returns None). Run `cargo test` — all tests MUST fail.

    GREEN phase: Implement format_upnp_duration and dlna_profile_for to make all tests pass. Then write and implement build_machine_namespace and media_item_id (these have property tests — determinism — not exact value tests).

    Implementation notes:
    - format_upnp_duration: Use `format!("{:02}:{:02}:{:02}.{:03}", h, m, s, ms)` — h has no upper bound, always at least 2 digits. ms = `(frac * 1000.0).round() as u32`.
    - dlna_profile_for: Use a `match mime { ... }` — static string matching, no regex. For video/mp4, return None in Phase 2 (per RESEARCH.md: defer profile to Phase 5). For image/jpeg and image/png use "JPEG_LRG" and "PNG_LRG" as unconditional assignments (no size-tier logic in Phase 2).
    - build_machine_namespace: Use `Uuid::new_v5(&Uuid::NAMESPACE_DNS, machine_id.as_bytes())` where machine_id comes from `machine_uid::get().unwrap_or_else(|_| "unknown".to_string())`.
    - media_item_id: Use `Uuid::new_v5(namespace, path.as_os_str().as_encoded_bytes())`.

    All four functions must be `pub`. Module must be added to `src/media/mod.rs` as `pub mod metadata;`.

    After implementing, run `cargo test media::metadata` — all tests must pass.
  </implementation>
</feature>

<verification>
1. RED phase commit exists: `cargo test media::metadata` shows at least 10 failing tests before implementation
2. GREEN phase: `cargo test media::metadata` passes all tests with 0 failures
3. `grep "pub fn format_upnp_duration" src/media/metadata.rs` returns a match
4. `grep "pub fn dlna_profile_for" src/media/metadata.rs` returns a match
5. Test: `cargo test -- --test-output immediate 2>&1 | grep "test media::metadata"` shows all tests passing
</verification>

<success_criteria>
All tests for format_upnp_duration and dlna_profile_for pass. The RED phase was demonstrated (tests failed before implementation). UUID helpers are implemented and produce deterministic results. `cargo test` runs with 0 failures across the full test suite.
</success_criteria>

<output>
After completion, create `.planning/phases/02-media-scanner-and-metadata/02-02-SUMMARY.md`
</output>
