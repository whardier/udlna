---
phase: 06-ssdp-discovery
plan: 03
type: execute
wave: 3
depends_on:
  - "06-02"
files_modified: []
autonomous: false
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04
  - CLI-06

must_haves:
  truths:
    - "A DLNA client tool can discover the server via SSDP M-SEARCH without manual configuration"
    - "Discovery response contains the correct LOCATION URL pointing to /device.xml"
    - "Server exits cleanly within 2 seconds of Ctrl+C with no orphan processes"
  artifacts:
    - path: "src/ssdp/service.rs"
      provides: "Running SSDP service confirmed working in practice"
    - path: "src/main.rs"
      provides: "Graceful shutdown confirmed working in practice"
  key_links:
    - from: "SSDP M-SEARCH response"
      to: "LOCATION URL"
      via: "discovery tool output"
      pattern: "LOCATION.*device\\.xml"
---

<objective>
End-to-end verification that SSDP discovery works correctly using a real SSDP tool, and that graceful shutdown operates as designed.

Purpose: SSDP behavior requires network testing — cargo tests cannot verify that UDP multicast packets are correctly formed and received by real DLNA clients.
Output: Confirmed working SSDP discovery and graceful shutdown.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ssdp-discovery/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated SSDP verification via gssdp-discover or equivalent</name>
  <files></files>
  <action>
Start the server in the background targeting a real media directory. Then use an SSDP discovery tool to send an M-SEARCH and capture the server's response.

**Step 1: Check available SSDP tools:**

```bash
which gssdp-discover 2>/dev/null || which ssdp-client 2>/dev/null || which upnpc 2>/dev/null
```

- If `gssdp-discover` is available: `gssdp-discover --timeout=5 2>&1 | head -40`
- If `upnpc` is available (miniupnpc): `upnpc -l 2>&1 | head -20`
- If none available: send a raw M-SEARCH via Python:

```bash
# Python M-SEARCH (works on macOS and Linux):
python3 -c "
import socket, time
MCAST = ('239.255.255.250', 1900)
msg = b'M-SEARCH * HTTP/1.1\r\nHOST: 239.255.255.250:1900\r\nMAN: \"ssdp:discover\"\r\nMX: 1\r\nST: ssdp:all\r\n\r\n'
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.settimeout(3)
s.sendto(msg, MCAST)
try:
    while True:
        data, addr = s.recvfrom(4096)
        print(f'From {addr}:')
        print(data.decode('utf-8', errors='replace'))
        print('---')
except socket.timeout:
    print('done')
"
```

**Step 2: Start the server** (use a real directory with at least one media file):

```bash
# Start server in background; capture output
cargo run --release -- /path/to/media-dir > /tmp/udlna-test.log 2>&1 &
SERVER_PID=$!
sleep 2  # Give server time to start and bind

# Run M-SEARCH (use whichever tool from Step 1)
python3 -c "..." 2>&1 | tee /tmp/udlna-msearch.txt

# Verify response contains LOCATION pointing to /device.xml
grep -i "LOCATION" /tmp/udlna-msearch.txt || echo "WARNING: No LOCATION found in response"

# Send Ctrl+C and verify clean exit
kill -INT $SERVER_PID
sleep 2
kill -0 $SERVER_PID 2>/dev/null && echo "STILL RUNNING - investigate" || echo "CLEAN EXIT OK"

# Check logs for byebye and Goodbye
grep -i "byebye\|Goodbye" /tmp/udlna-test.log
```

**What to look for in the response:**
- `HTTP/1.1 200 OK` start line
- `LOCATION: http://<server-ip>:<port>/device.xml` header
- `ST: upnp:rootdevice` or whichever ST was requested
- `USN: uuid:<server-uuid>::upnp:rootdevice`
- `CACHE-CONTROL: max-age=900`

**Expected startup log:** `INFO udlna: SSDP advertising on 192.168.x.x:1900`

**Expected shutdown log:**
```
INFO udlna: Shutting down — sending SSDP byebye...
INFO udlna: SSDP: byebye sent
INFO udlna: Goodbye.
```

If Python M-SEARCH returns no responses, ensure the server is running on a non-loopback interface (not `--localhost` mode). SSDP multicast only works on interfaces connected to a real network.
  </action>
  <verify>grep -i "LOCATION" /tmp/udlna-msearch.txt shows a URL containing /device.xml; grep "CLEAN EXIT OK" verifies process terminated; grep -i "byebye" /tmp/udlna-test.log confirms byebye was sent</verify>
  <done>SSDP M-SEARCH receives a valid 200 OK response with correct LOCATION URL; Ctrl+C causes clean process exit with byebye logged; no orphan udlna processes remain</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of end-to-end SSDP discovery and graceful shutdown</name>
  <files></files>
  <action>Human verifies SSDP discovery and graceful shutdown work correctly as described in how-to-verify steps below.</action>
  <verify>User confirms "approved" after testing all verification steps.</verify>
  <done>User has confirmed SSDP M-SEARCH returns valid response, startup advertises on correct interface, Ctrl+C exits cleanly with byebye.</done>
  <what-built>
Complete SSDP discovery implementation:
- Server responds to M-SEARCH with unicast 200 OK containing LOCATION URL (DISC-01)
- Server sends NOTIFY alive burst on startup (DISC-02)
- Server re-advertises every 900 seconds (DISC-03)
- Ctrl+C sends byebye before exit (DISC-04)
- Graceful shutdown with 1s byebye timeout (CLI-06)
  </what-built>
  <how-to-verify>
1. Start the server: `cargo run -- /path/to/media-dir`
2. Confirm startup log shows: `SSDP advertising on {ip}:1900`
3. From another terminal, run the Python M-SEARCH snippet or `upnpc -l`
4. Confirm the response contains `LOCATION: http://{server-ip}:8200/device.xml`
5. Press Ctrl+C in the server terminal
6. Confirm log shows SSDP byebye message followed by "Goodbye."
7. Confirm process exits within 2 seconds (not hanging)
8. Optional: open VLC, go to View > Playlist > Local Network > Universal Plug'n'Play, and confirm the server appears in the device list
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found (e.g., "no SSDP response received", "byebye not logged", "process hung")</resume-signal>
</task>

</tasks>

<verification>
- SSDP M-SEARCH produces a valid 200 OK response with LOCATION URL
- LOCATION URL is reachable: `curl {location_url}` returns device.xml content
- Process exits within 2 seconds of Ctrl+C
- Log shows "byebye" and "Goodbye." in correct order
</verification>

<success_criteria>
Phase 6 is complete when: SSDP M-SEARCH returns a valid response, startup advertises on the correct interface, Ctrl+C exits cleanly with byebye, and a real DLNA client (VLC or equivalent) can discover the server automatically.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ssdp-discovery/06-03-SUMMARY.md`
</output>
