---
phase: 04-device-service-description
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified: []
autonomous: false
requirements:
  - DESC-01
  - DESC-02
  - DESC-03

must_haves:
  truths:
    - "curl /device.xml returns 200 with text/xml content-type and MediaServer:1 device type"
    - "curl /cds/scpd.xml returns 200 with text/xml content-type and Browse action definition"
    - "curl /cms/scpd.xml returns 200 with text/xml content-type and GetProtocolInfo action definition"
    - "curl /cds/control returns 501 (Phase 5 stub, not yet implemented)"
  artifacts:
    - path: "src/http/description.rs"
      provides: "Live handlers verified serving correct XML over HTTP"
      contains: "serve_device_xml"
  key_links:
    - from: "curl http://localhost:8200/device.xml"
      to: "description::serve_device_xml"
      via: "axum route registration in build_router"
      pattern: "MediaServer:1"
---

<objective>
End-to-end curl verification that /device.xml, /cds/scpd.xml, and /cms/scpd.xml serve correct XML responses over HTTP.

Purpose: Plan 01 builds and wires the handlers, but a live server test confirms the full stack (TCP -> axum -> handler -> Content-Type -> XML body) is working. This is the phase acceptance gate.

Output: No new files. User confirms all three description endpoints return correct XML.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-device-service-description/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start the server and run automated curl checks</name>
  <files></files>
  <action>
Start the server in the background against a test media directory, then run curl checks against all three description endpoints plus the Phase 5 stubs to confirm they return the expected status codes.

```bash
# Start server in background (requires at least one media file directory)
# If no media directory exists, create a temp one with a dummy file
mkdir -p /tmp/udlna-test-media
touch /tmp/udlna-test-media/test.mp3
cargo run --release -- /tmp/udlna-test-media &
SERVER_PID=$!
sleep 2  # Wait for server to bind

# Check device.xml -- expect 200 with MediaServer:1
echo "=== /device.xml ==="
curl -s -i http://localhost:8200/device.xml

# Check cds/scpd.xml -- expect 200 with Browse action
echo ""
echo "=== /cds/scpd.xml ==="
curl -s -i http://localhost:8200/cds/scpd.xml

# Check cms/scpd.xml -- expect 200 with GetProtocolInfo action
echo ""
echo "=== /cms/scpd.xml ==="
curl -s -i http://localhost:8200/cms/scpd.xml

# Check control stubs -- expect 501
echo ""
echo "=== /cds/control (expect 501) ==="
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8200/cds/control

echo ""
echo "=== /cms/control (expect 501) ==="
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8200/cms/control

# Stop server
kill $SERVER_PID 2>/dev/null
```

Capture the output and confirm before proceeding to the checkpoint.
  </action>
  <verify>
All curl checks pass:
- /device.xml: HTTP 200, content-type: text/xml, body contains "MediaServer:1" and "X_DLNADOC"
- /cds/scpd.xml: HTTP 200, content-type: text/xml, body contains "Browse" and "GetSearchCapabilities"
- /cms/scpd.xml: HTTP 200, content-type: text/xml, body contains "GetProtocolInfo" and "GetCurrentConnectionIDs"
- /cds/control POST: HTTP 501
- /cms/control POST: HTTP 501
  </verify>
  <done>All five curl responses match expected status codes and body content. Server process terminated cleanly after test.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of description endpoints</name>
  <action>
Pause for user to manually verify all three description XML endpoints are working correctly.
  </action>
  <what-built>
Plan 01 implemented three axum handlers in src/http/description.rs serving spec-compliant UPnP device description XML and SCPD service description documents. AppState was extended with server_uuid (UUID v4 generated at startup). The three Phase 4 stubs in build_router were replaced with the real handlers. Phase 5 control stubs remain 501.

Task 1 of this plan ran automated curl checks and captured output.
  </what-built>
  <how-to-verify>
Start udlna against any media directory and verify the three description endpoints manually:

1. Start server: `cargo run --release -- /path/to/any/media/dir`

2. Fetch device.xml and confirm:
   ```
   curl http://localhost:8200/device.xml
   ```
   Expected: XML with `<deviceType>urn:schemas-upnp-org:device:MediaServer:1</deviceType>`, `<dlna:X_DLNADOC>DMS-1.50</dlna:X_DLNADOC>`, `<UDN>uuid:...`, ContentDirectory and ConnectionManager service declarations with serviceId using `urn:upnp-org:serviceId:...` (not urn:schemas-upnp-org)

3. Fetch ContentDirectory SCPD and confirm it lists Browse action:
   ```
   curl http://localhost:8200/cds/scpd.xml
   ```
   Expected: XML with Browse, GetSearchCapabilities, GetSortCapabilities, GetSystemUpdateID actions and matching serviceStateTable entries

4. Fetch ConnectionManager SCPD and confirm it lists GetProtocolInfo:
   ```
   curl http://localhost:8200/cms/scpd.xml
   ```
   Expected: XML with GetProtocolInfo, GetCurrentConnectionIDs, GetCurrentConnectionInfo actions

5. Confirm control stubs still return 501:
   ```
   curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8200/cds/control
   ```
   Expected: 501
  </how-to-verify>
  <verify>User confirms all three description endpoints return correct XML with HTTP 200 and text/xml content-type.</verify>
  <done>User has typed "approved" confirming all description endpoints serve correct XML.</done>
  <resume-signal>Type "approved" if all endpoints return correct XML, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 4 complete when:
1. All three description endpoints return HTTP 200 with text/xml content-type
2. /device.xml body contains MediaServer:1, dlna:X_DLNADOC, both service declarations with correct serviceId format
3. /cds/scpd.xml body contains all 4 ContentDirectory actions and complete serviceStateTable
4. /cms/scpd.xml body contains all 3 ConnectionManager actions and complete serviceStateTable
5. /cds/control and /cms/control return 501 (Phase 5 work remaining)
</verification>

<success_criteria>
User has verified all three description endpoints return correct XML. Phase 4 requirements DESC-01, DESC-02, DESC-03 are satisfied and curl-verifiable by any DLNA client implementation team.
</success_criteria>

<output>
After completion, create `.planning/phases/04-device-service-description/04-02-SUMMARY.md`
</output>
