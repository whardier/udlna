---
phase: 05-contentdirectory-service
plan: "03"
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/http/content_directory.rs
  - src/http/mod.rs
autonomous: true
requirements: [CONT-06, CONT-07, CONT-08]

must_haves:
  truths:
    - "POST to /cds/control with SOAPAction GetSearchCapabilities returns 200 with empty SearchCaps element"
    - "POST to /cds/control with SOAPAction GetSortCapabilities returns 200 with empty SortCaps element"
    - "POST to /cds/control with SOAPAction GetSystemUpdateID returns 200 with Id element containing 1"
    - "POST to /cds/control with unknown SOAPAction returns 500 SOAP fault with error code 402"
    - "POST to /cds/control with valid Browse SOAPAction returns 501-level stub (not 501 text, but dispatches to browse placeholder)"
  artifacts:
    - path: "src/http/content_directory.rs"
      provides: "cds_control handler with action dispatch and stub actions"
      min_lines: 80
    - path: "src/http/mod.rs"
      provides: "Router with /cds/control pointing to content_directory::cds_control"
      contains: "content_directory"
  key_links:
    - from: "src/http/mod.rs"
      to: "src/http/content_directory.rs"
      via: "axum route registration .route(\"/cds/control\", post(content_directory::cds_control))"
      pattern: "content_directory::cds_control"
    - from: "src/http/content_directory.rs"
      to: "src/http/soap.rs"
      via: "soap_response() and soap_fault() utility functions"
      pattern: "crate::http::soap::"
---

<objective>
Create `src/http/content_directory.rs` with the main `cds_control` handler and action dispatcher. Implement the three simple stub actions (GetSearchCapabilities, GetSortCapabilities, GetSystemUpdateID) fully. Add a `handle_browse` placeholder that returns a 501-style SOAP fault — Browse is completed in Plan 04. Wire the handler into `src/http/mod.rs` replacing the current 501 stub.

Purpose: The action dispatch infrastructure (SOAPAction header parsing, match dispatch, error fault generation) is independent of Browse complexity and can be verified separately with curl before Plan 04's complex Browse logic.

Output: Working `/cds/control` endpoint that correctly handles GetSearchCapabilities, GetSortCapabilities, and GetSystemUpdateID. Browse returns a placeholder fault until Plan 04.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-contentdirectory-service/05-CONTEXT.md
@.planning/phases/05-contentdirectory-service/05-RESEARCH.md
@src/http/mod.rs
@src/http/soap.rs
@src/http/state.rs
@src/media/library.rs
@.planning/phases/05-contentdirectory-service/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/http/content_directory.rs with action dispatch and stub actions</name>
  <files>src/http/content_directory.rs</files>
  <action>
    Create `src/http/content_directory.rs`. This file contains the main handler and all action implementations.

    **Imports:**
    ```rust
    use axum::{
        extract::State,
        http::{header, HeaderMap, StatusCode},
        response::IntoResponse,
        response::Response,
    };
    use crate::http::soap::{
        self, CDS_NAMESPACE, soap_response, soap_fault, extract_soap_param,
    };
    use crate::http::state::AppState;
    ```

    **cds_control handler:**
    ```rust
    pub async fn cds_control(
        State(state): State<AppState>,
        headers: HeaderMap,
        body: String,
    ) -> Response
    ```

    Extract action from SOAPAction header using the pattern from RESEARCH.md Pattern 1:
    ```
    headers.get("soapaction")  // axum HeaderMap is case-insensitive
        .and_then(|v| v.to_str().ok())
        .and_then(|s| s.split('#').nth(1))
        .map(|s| s.trim_matches('"'))
    ```

    If SOAPAction is absent or empty, fall back to parsing the SOAP body for the action element name (search for `<u:` tag to extract local action name). This handles RESEARCH.md Pitfall 3 (clients that omit SOAPAction header).

    Dispatch:
    ```rust
    match action.as_deref() {
        Some("Browse") => handle_browse(&state, &headers, &body).await,
        Some("GetSearchCapabilities") => handle_get_search_capabilities(),
        Some("GetSortCapabilities") => handle_get_sort_capabilities(),
        Some("GetSystemUpdateID") => handle_get_system_update_id(),
        _ => {
            tracing::warn!("Unknown CDS action: {:?}", action);
            soap_fault(402, "InvalidArgs").into_response()
        }
    }
    ```

    **handle_get_search_capabilities() -> Response:**
    Returns `soap_response("GetSearchCapabilities", "<SearchCaps></SearchCaps>")` wrapped in `(StatusCode::OK, [(header::CONTENT_TYPE, "text/xml; charset=\"utf-8\"")], body).into_response()`.

    **handle_get_sort_capabilities() -> Response:**
    Returns `soap_response("GetSortCapabilities", "<SortCaps></SortCaps>")` same wrapping.

    **handle_get_system_update_id() -> Response:**
    Returns `soap_response("GetSystemUpdateID", "<Id>1</Id>")` same wrapping.
    Note: Element name is `Id` with capital I lowercase d (RESEARCH.md code example confirmed).

    **handle_browse(state: &AppState, headers: &HeaderMap, body: &str) -> Response (placeholder):**
    For now, return a `soap_fault(401, "Action Failed")` response indicating Browse is not yet implemented. Plan 04 replaces this function with the real Browse implementation. Use `tracing::debug!("Browse not yet implemented")` before returning.

    Helper: Extract soap response as `(StatusCode::OK, [(header::CONTENT_TYPE, "text/xml; charset=\"utf-8\"")], String)`. Consider a small `ok_xml(body: String) -> Response` inline helper to avoid repeating the tuple.
  </action>
  <verify>
    Run: `cargo build 2>&1 | grep "^error"`
    Expected: No error lines.
  </verify>
  <done>
    `cargo build` exits 0. File `src/http/content_directory.rs` exists with `cds_control`, `handle_get_search_capabilities`, `handle_get_sort_capabilities`, `handle_get_system_update_id`, and `handle_browse` functions all compiling cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire content_directory into mod.rs and verify stub actions with curl</name>
  <files>src/http/mod.rs</files>
  <action>
    Update `src/http/mod.rs`:

    1. Add `pub mod content_directory;` declaration alongside the existing mod declarations.

    2. Replace the existing Phase 5 `/cds/control` stub:
    ```rust
    // Replace:
    .route("/cds/control", axum::routing::post(|| async {
        (axum::http::StatusCode::NOT_IMPLEMENTED, "Not Implemented")
    }))

    // With:
    .route("/cds/control", axum::routing::post(content_directory::cds_control))
    ```

    Keep the `/cms/control` stub as-is (Phase 7 implements ConnectionManager).

    After wiring, run `cargo build` to confirm compilation. Then start the server in background and verify the three stub actions respond correctly:

    ```bash
    # Start server (use a test media dir or /tmp)
    cargo run -- /tmp &
    SERVER_PID=$!
    sleep 2

    # Test GetSearchCapabilities
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#GetSearchCapabilities"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetSearchCapabilities xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"></u:GetSearchCapabilities></s:Body></s:Envelope>'

    # Test GetSortCapabilities
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#GetSortCapabilities"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetSortCapabilities xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"></u:GetSortCapabilities></s:Body></s:Envelope>'

    # Test GetSystemUpdateID
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#GetSystemUpdateID"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:GetSystemUpdateID xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"></u:GetSystemUpdateID></s:Body></s:Envelope>'

    # Test unknown action → 500 SOAP fault
    curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#UnknownAction"' \
      -H 'Content-Type: text/xml' \
      -d '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body></s:Body></s:Envelope>'

    kill $SERVER_PID
    ```
  </action>
  <verify>
    - GetSearchCapabilities response contains `<SearchCaps></SearchCaps>` (or `<SearchCaps/>`)
    - GetSortCapabilities response contains `<SortCaps></SortCaps>` (or `<SortCaps/>`)
    - GetSystemUpdateID response contains `<Id>1</Id>`
    - Unknown action returns HTTP 500 with SOAP fault body containing `<errorCode>402</errorCode>`
    - All responses have Content-Type `text/xml`
  </verify>
  <done>
    All four curl tests return expected responses. `cargo build` exits 0. `/cds/control` is no longer a 501 stub — it dispatches correctly to CDS action handlers.
  </done>
</task>

</tasks>

<verification>
`cargo build` exits 0.
`cargo test` exits 0 (no regressions).
All four curl verifications pass (GetSearchCapabilities, GetSortCapabilities, GetSystemUpdateID, unknown action 500).
</verification>

<success_criteria>
- `src/http/content_directory.rs` exists with all five functions
- `src/http/mod.rs` declares `pub mod content_directory` and routes /cds/control to it
- curl GetSearchCapabilities returns 200 with `SearchCaps` empty element in SOAP envelope
- curl GetSortCapabilities returns 200 with `SortCaps` empty element in SOAP envelope
- curl GetSystemUpdateID returns 200 with `<Id>1</Id>` in SOAP envelope
- curl unknown SOAPAction returns 500 with `<errorCode>402</errorCode>`
</success_criteria>

<output>
After completion, create `.planning/phases/05-contentdirectory-service/05-03-SUMMARY.md`
</output>
