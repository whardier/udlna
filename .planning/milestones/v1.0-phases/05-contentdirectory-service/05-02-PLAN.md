---
phase: 05-contentdirectory-service
plan: "02"
type: tdd
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/http/soap.rs
autonomous: true
requirements: [CONT-04, CONT-05]

must_haves:
  truths:
    - "extract_soap_param correctly extracts ObjectID, BrowseFlag, StartingIndex, RequestedCount from real SOAP body strings"
    - "apply_pagination returns all items when RequestedCount=0 (UPnP spec requirement)"
    - "apply_pagination returns correct slices for StartingIndex beyond end, normal ranges"
    - "build_protocol_info produces correct string with DLNA.ORG_PN when profile is Some"
    - "build_protocol_info omits DLNA.ORG_PN entirely when profile is None"
    - "container_uuid returns non-nil, deterministic UUIDs for all four container names"
    - "container_uuid returns different UUIDs for different container names"
  artifacts:
    - path: "src/http/soap.rs"
      provides: "Pure function implementations with #[cfg(test)] module"
      min_lines: 120
  key_links:
    - from: "src/http/soap.rs tests"
      to: "apply_pagination"
      via: "RequestedCount=0 → return all items"
      pattern: "requested_count.*0"
    - from: "src/http/soap.rs tests"
      to: "build_protocol_info"
      via: "DLNA.ORG_PN present/absent based on profile option"
      pattern: "DLNA.ORG_PN"
---

<objective>
TDD cycle for the pure utility functions in `src/http/soap.rs`. Write failing tests first, then verify functions from Plan 01 make them pass. Focus on the edge cases most likely to cause DLNA client failures: the RequestedCount=0 pagination quirk, protocolInfo string format, XML escaping, and parameter extraction from real SOAP body strings.

Purpose: These functions have defined I/O contracts and real DLNA behavior depends on their correctness. TDD ensures the spec edge cases are encoded as assertions before the Browse handler calls them.

Output: `src/http/soap.rs` with a `#[cfg(test)]` module containing passing tests for all pure utility functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-contentdirectory-service/05-CONTEXT.md
@.planning/phases/05-contentdirectory-service/05-RESEARCH.md
@src/http/soap.rs
@src/media/metadata.rs
@.planning/phases/05-contentdirectory-service/05-01-SUMMARY.md
</context>

<feature>
  <name>SOAP utility function correctness</name>
  <files>src/http/soap.rs (test module appended)</files>
  <behavior>
    Test cases covering the spec-critical behaviors:

    **extract_soap_param:**
    - Input: Real Browse SOAP body string with `<ObjectID>0</ObjectID>` → Output: `Some("0")`
    - Input: SOAP body with `<StartingIndex>5</StartingIndex>` → Output: `Some("5")`
    - Input: SOAP body missing the param entirely → Output: `None`
    - Input: SOAP body with `<RequestedCount>0</RequestedCount>` → Output: `Some("0")`

    **apply_pagination:**
    - `apply_pagination(&[1,2,3,4,5], 0, 0)` → returns all 5 items (RequestedCount=0 = all)
    - `apply_pagination(&[1,2,3,4,5], 2, 0)` → returns items [3,4,5] (StartingIndex=2, count=0=all remaining)
    - `apply_pagination(&[1,2,3,4,5], 1, 2)` → returns [2,3]
    - `apply_pagination(&[1,2,3,4,5], 10, 5)` → returns empty slice (StartingIndex beyond end)
    - `apply_pagination(&[1,2,3,4,5], 0, 3)` → returns [1,2,3]
    - `apply_pagination(&[], 0, 0)` → returns empty slice

    **build_protocol_info:**
    - With profile `Some("MP3")`, mime `"audio/mpeg"` → string contains `"DLNA.ORG_PN=MP3"` and `"DLNA.ORG_OP=01"` and `"DLNA.ORG_FLAGS=01700000000000000000000000000000"`
    - With profile `None`, mime `"video/x-matroska"` → string does NOT contain `"DLNA.ORG_PN"`, does contain `"DLNA.ORG_OP=01"`
    - Both forms start with `"http-get:*:{mime}:"`

    **container_uuid:**
    - `container_uuid("Videos")` returns non-nil Uuid
    - `container_uuid("Videos")` called twice returns same value (deterministic)
    - `container_uuid("Videos")` != `container_uuid("Music")` (different names → different UUIDs)
    - `container_uuid("Photos")` != `container_uuid("All Media")`

    **xml_escape:**
    - `xml_escape("hello & world")` → contains `&amp;`
    - `xml_escape("<title>")` → contains `&lt;`
    - `xml_escape("normal text")` → returns unchanged

    **soap_response:**
    - Output contains `<?xml version="1.0"` and `</s:Envelope>`
    - Output contains the action name in `BrowseResponse` tag form
    - Output contains the inner_xml unchanged (not escaped again)
  </behavior>
  <implementation>
    All functions were implemented in Plan 01. This TDD plan ONLY adds the `#[cfg(test)]` module.

    **RED phase:** Add the test module with all test functions. Run `cargo test -- --test-filter soap` — tests MUST pass immediately since functions are already implemented (this is a post-hoc TDD verification, not pre-implementation TDD). If any test fails, the Plan 01 implementation has a bug — fix it in soap.rs.

    **GREEN phase:** All tests pass. `cargo test` exits 0.

    **REFACTOR (if needed):** If any function from Plan 01 had to be fixed to make tests pass, ensure the fix doesn't break other tests.

    Append the test module to the bottom of `src/http/soap.rs`:
    ```rust
    #[cfg(test)]
    mod tests {
        use super::*;

        // Test: extract_soap_param extracts ObjectID
        #[test]
        fn extract_soap_param_object_id() { ... }

        // Test: extract_soap_param returns None for missing param
        #[test]
        fn extract_soap_param_missing_returns_none() { ... }

        // Test: apply_pagination with RequestedCount=0 returns all
        #[test]
        fn apply_pagination_zero_count_returns_all() { ... }

        // ... (all cases from behavior section)
    }
    ```

    Commit sequence:
    1. `test(05-02): add failing tests for soap utility functions` (add tests, run cargo test to confirm pass/fail)
    2. If any test failed and required soap.rs fix: `feat(05-02): fix soap utility function` + `refactor(05-02): clean up after fix`
    3. If all tests passed immediately: `feat(05-02): verify soap utility functions with tests`
  </implementation>
</feature>

<verification>
`cargo test -- soap 2>&1 | grep -E "^(test|FAILED|ok|error)"` — all soap tests pass.
`cargo test` exits 0 — no regressions in other test modules.
</verification>

<success_criteria>
- At least 15 test cases covering extract_soap_param, apply_pagination, build_protocol_info, container_uuid, xml_escape, and soap_response
- All tests pass: `cargo test` exits 0
- The RequestedCount=0 pagination behavior is explicitly tested and passes
- The build_protocol_info None-profile case (no DLNA.ORG_PN) is explicitly tested
</success_criteria>

<output>
After completion, create `.planning/phases/05-contentdirectory-service/05-02-SUMMARY.md`
</output>
