---
phase: 05-contentdirectory-service
plan: "04"
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/http/content_directory.rs
autonomous: true
requirements: [CONT-01, CONT-02, CONT-03, CONT-04, CONT-05]

must_haves:
  truths:
    - "Browse(BrowseDirectChildren, ObjectID=0) returns DIDL-Lite with four containers: Videos, Music, Photos, All Media"
    - "Browse(BrowseDirectChildren, ObjectID={videos_container_uuid}) returns only video MediaItems as DIDL-Lite item elements"
    - "Browse(BrowseDirectChildren, ObjectID={music_container_uuid}) returns only audio MediaItems"
    - "Browse(BrowseDirectChildren, ObjectID={photos_container_uuid}) returns only image MediaItems"
    - "Browse(BrowseDirectChildren, ObjectID={all_media_uuid}) returns all MediaItems"
    - "Browse(BrowseMetadata, ObjectID=0) returns root container element with childCount=4"
    - "Browse(BrowseMetadata, ObjectID={container_uuid}) returns that container element with correct childCount"
    - "Browse(BrowseMetadata, ObjectID={item_uuid}) returns that item's full DIDL-Lite item element"
    - "Browse with unknown ObjectID returns HTTP 500 SOAP fault with errorCode 701"
    - "Browse pagination: StartingIndex=5, RequestedCount=3 returns 3 items starting at index 5"
    - "Browse pagination: RequestedCount=0 returns all items from StartingIndex onward"
    - "DIDL-Lite Result element contains XML-escaped DIDL-Lite (& becomes &amp;, < becomes &lt;)"
    - "res element protocolInfo uses DLNA.ORG_PN when dlna_profile is Some, omits it when None"
    - "dc:title is filename without extension (file_stem, not file_name)"
    - "dc:date is present on all item elements"
    - "DIDL-Lite root element has all four required namespaces"
  artifacts:
    - path: "src/http/content_directory.rs"
      provides: "Complete Browse handler with BrowseDirectChildren + BrowseMetadata + pagination"
      min_lines: 200
  key_links:
    - from: "src/http/content_directory.rs handle_browse"
      to: "src/http/soap.rs apply_pagination"
      via: "pagination of item slices"
      pattern: "apply_pagination"
    - from: "src/http/content_directory.rs"
      to: "quick_xml::escape::escape (via soap::xml_escape)"
      via: "DIDL-Lite XML escaping before embedding in Result element"
      pattern: "xml_escape|escape"
    - from: "src/http/content_directory.rs"
      to: "AppState.library"
      via: "RwLock read guard to access MediaLibrary items"
      pattern: "library\\.read"
    - from: "DIDL-Lite <Result> element"
      to: "DIDL-Lite XML string"
      via: "xml_escape() called on complete DIDL-Lite string before embedding"
      pattern: "xml_escape.*didl|escape.*didl"
---

<objective>
Implement the full Browse action handler in `src/http/content_directory.rs`. Replace the Plan 03 placeholder `handle_browse` function with complete BrowseDirectChildren and BrowseMetadata logic including the four-container hierarchy, full DIDL-Lite item and container element generation, pagination, and 701 fault for unknown ObjectIDs.

Purpose: Browse is the core of DLNA content delivery. Without it, DLNA clients can discover the server but see no content. This plan completes Phase 5.

Output: `/cds/control` Browse action fully functional — DLNA clients can enumerate and browse the complete media library hierarchy.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-contentdirectory-service/05-CONTEXT.md
@.planning/phases/05-contentdirectory-service/05-RESEARCH.md
@src/http/content_directory.rs
@src/http/soap.rs
@src/http/state.rs
@src/media/library.rs
@src/media/metadata.rs
@.planning/phases/05-contentdirectory-service/05-02-SUMMARY.md
@.planning/phases/05-contentdirectory-service/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement full Browse handler — BrowseDirectChildren and BrowseMetadata</name>
  <files>src/http/content_directory.rs</files>
  <action>
    Replace the `handle_browse` placeholder from Plan 03 with the complete implementation. This is the largest single function in Phase 5 — keep it clean by extracting DIDL-Lite generation into private helper functions.

    **Setup — Container definitions:**
    ```rust
    // Derive container UUIDs once per request (deterministic, cheap)
    let videos_id = soap::container_uuid(soap::CONTAINER_VIDEOS);
    let music_id  = soap::container_uuid(soap::CONTAINER_MUSIC);
    let photos_id = soap::container_uuid(soap::CONTAINER_PHOTOS);
    let all_id    = soap::container_uuid(soap::CONTAINER_ALL_MEDIA);
    ```

    **Parse Browse parameters from SOAP body:**
    Use `extract_soap_param(body, "ObjectID")`, `extract_soap_param(body, "BrowseFlag")`, `extract_soap_param(body, "StartingIndex").and_then(|s| s.parse::<u32>().ok()).unwrap_or(0)`, `extract_soap_param(body, "RequestedCount").and_then(|s| s.parse::<u32>().ok()).unwrap_or(0)`.

    If ObjectID or BrowseFlag is None/missing, return `soap_fault(402, "InvalidArgs").into_response()`.

    **Acquire library read guard:**
    ```rust
    let lib = state.library.read().expect("library lock poisoned");
    ```

    **Dispatch on browse_flag:**

    **BrowseDirectChildren:**
    Match object_id.as_str() against "0", videos_id.to_string(), music_id, photos_id, all_id.

    - `"0"` (root): Return DIDL-Lite with four `<container>` elements.
      Each container: `id={uuid}`, `parentID="0"`, `restricted="1"`, `childCount={item_count_for_this_type}`.
      `<dc:title>{name}</dc:title>`, `<upnp:class>object.container.storageFolder</upnp:class>`.
      Apply pagination to the four containers using `apply_pagination`.
      TotalMatches = 4 (always 4 containers at root).

    - videos_id: Filter `lib.items` for `MediaKind::Video`. Apply pagination. Generate item elements.
    - music_id: Filter for `MediaKind::Audio`. Apply pagination. Generate item elements.
    - photos_id: Filter for `MediaKind::Image`. Apply pagination. Generate item elements.
    - all_id: Use all `lib.items` (already all non-Subtitle). Apply pagination. Generate item elements.

    - Unknown ObjectID: Return `soap_fault(701, "No such object").into_response()`.

    **BrowseMetadata:**
    Match object_id against "0" → root container element (childCount=4, parentID="-1").
    Match against known container UUIDs → that container element (childCount=item_count, parentID="0").
    Search `lib.items` for item with id matching object_id UUID: `lib.items.iter().find(|it| it.id.to_string() == object_id)`.
    If found → single item element. If not found → `soap_fault(701, "No such object")`.

    **DIDL-Lite generation helpers (private functions):**

    `fn didl_lite_wrap(inner: &str) -> String` — wraps content in DIDL-Lite root with all four namespaces:
    ```
    <DIDL-Lite xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/"
      xmlns:dc="http://purl.org/dc/elements/1.1/"
      xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/"
      xmlns:dlna="urn:schemas-dlna-org:metadata-1-0/">
    {inner}
    </DIDL-Lite>
    ```
    CRITICAL: All four namespaces required. Samsung TVs reject missing `xmlns:dlna` silently.

    `fn container_element(id: &str, parent_id: &str, title: &str, child_count: usize) -> String` — generates `<container>` element. Use `soap::xml_escape(title)` on title. upnp:class = `"object.container.storageFolder"`.

    `fn item_element(item: &crate::media::library::MediaItem, parent_id: &str, headers: &axum::http::HeaderMap) -> String` — generates `<item>` element:
    - `id` = `item.id.to_string()`
    - `parentID` = parent_id (the container UUID whose Browse returned this item)
    - `dc:title` = `item.path.file_stem().and_then(|s| s.to_str()).unwrap_or("")` — use `file_stem()` NOT `file_name()` (RESEARCH.md Pitfall 8)
    - `upnp:class` = match item.kind: Video → `"object.item.videoItem"`, Audio → `"object.item.audioItem.musicTrack"`, Image → `"object.item.imageItem.photo"`, _ → `"object.item"`
    - `dc:date` = `soap::format_dc_date(&item.path)` — ALWAYS include (RESEARCH.md Pitfall 5)
    - `res` attributes: `protocolInfo` = `soap::build_protocol_info(item.mime, item.meta.dlna_profile)`, `size` = `item.file_size`
    - Conditional `res` attributes: `duration` if `item.meta.duration.is_some()`, `resolution` if `item.meta.resolution.is_some()`, `bitrate` if `item.meta.bitrate.is_some()`
    - res URL = `soap::build_res_url(headers, &item.id)` using Host header

    Apply `soap::xml_escape()` to: dc:title content, res URL content. Attribute values (protocolInfo, etc.) do not need escaping as they don't contain special chars.

    **Browse response assembly:**
    ```rust
    let didl_xml = didl_lite_wrap(&elements_string);
    // CRITICAL: escape the entire DIDL-Lite string before embedding in Result
    let inner = format!(
        "<Result>{}</Result><NumberReturned>{}</NumberReturned><TotalMatches>{}</TotalMatches><UpdateID>1</UpdateID>",
        soap::xml_escape(&didl_xml),  // MUST escape — RESEARCH.md Pitfall 1
        number_returned,
        total_matches
    );
    let body = soap_response("Browse", &inner);
    ok_xml(body)
    ```

    **Anti-patterns to avoid (from RESEARCH.md):**
    - DO NOT embed raw DIDL-Lite XML in Result — MUST call `soap::xml_escape()` on the entire DIDL-Lite string
    - DO NOT return HTTP 200 for 701 unknown ObjectID — use `soap_fault(701, ...)` (HTTP 500)
    - DO NOT use `file_name()` for title — use `file_stem()`
    - DO NOT omit `xmlns:dlna` from DIDL-Lite root element
    - DO NOT use `object.container` — use `object.container.storageFolder`
  </action>
  <verify>
    Run `cargo build 2>&1 | grep "^error"` — no errors.
    Run `cargo test` — exits 0.
    Start server: `cargo run -- /tmp &` (or a directory with test media files).
    Run Browse curl test:
    ```bash
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>0</ObjectID><BrowseFlag>BrowseDirectChildren</BrowseFlag><Filter>*</Filter><StartingIndex>0</StartingIndex><RequestedCount>0</RequestedCount><SortCriteria></SortCriteria></u:Browse></s:Body></s:Envelope>'
    ```
    Response must contain `BrowseResponse`, `<Result>`, `TotalMatches`, and escaped DIDL-Lite with container elements.
  </verify>
  <done>
    Browse BrowseDirectChildren on ObjectID=0 returns SOAP envelope with four container elements in escaped DIDL-Lite.
    `cargo build` and `cargo test` both exit 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end curl verification of all Browse cases</name>
  <files>src/http/content_directory.rs</files>
  <action>
    This task runs a comprehensive curl verification of all Browse scenarios. If any check fails, fix the implementation in content_directory.rs before proceeding.

    Start the server with a media directory that has at least one video file (or use /tmp — containers will have 0 items but still respond correctly):
    ```bash
    cargo run -- /tmp &
    SERVER_PID=$!
    sleep 2
    ```

    **Check 1: BrowseDirectChildren on root (ObjectID=0)**
    ```bash
    BROWSE_SOAP='<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>0</ObjectID><BrowseFlag>BrowseDirectChildren</BrowseFlag><Filter>*</Filter><StartingIndex>0</StartingIndex><RequestedCount>0</RequestedCount><SortCriteria></SortCriteria></u:Browse></s:Body></s:Envelope>'

    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d "$BROWSE_SOAP" | grep -c "container"
    # Expected: >= 4 (four container elements in escaped DIDL-Lite)
    ```

    **Check 2: BrowseMetadata on root (ObjectID=0)**
    ```bash
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>0</ObjectID><BrowseFlag>BrowseMetadata</BrowseFlag><Filter>*</Filter><StartingIndex>0</StartingIndex><RequestedCount>0</RequestedCount><SortCriteria></SortCriteria></u:Browse></s:Body></s:Envelope>'
    # Expected: Contains TotalMatches>0 (or =1 for single root container)
    #           Contains NumberReturned=1
    #           Response is HTTP 200
    ```

    **Check 3: Unknown ObjectID → 701 SOAP fault**
    ```bash
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d '<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>ffffffff-ffff-ffff-ffff-ffffffffffff</ObjectID><BrowseFlag>BrowseDirectChildren</BrowseFlag><Filter>*</Filter><StartingIndex>0</StartingIndex><RequestedCount>0</RequestedCount><SortCriteria></SortCriteria></u:Browse></s:Body></s:Envelope>')
    echo "Status: $STATUS"
    # Expected: 500
    ```

    **Check 4: DIDL-Lite escaping — Result element contains &amp; not raw &**
    ```bash
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d "$BROWSE_SOAP" | grep -o "Result>.*</Result" | head -c 200
    # Expected: Contains &lt;DIDL-Lite (escaped), NOT raw <DIDL-Lite
    # The < in <DIDL-Lite must appear as &lt; inside the Result element
    ```

    **Check 5: All four required DIDL-Lite namespaces present in escaped content**
    ```bash
    curl -s -X POST http://localhost:8200/cds/control \
      -H 'SOAPAction: "urn:schemas-upnp-org:service:ContentDirectory:1#Browse"' \
      -H 'Content-Type: text/xml' \
      -d "$BROWSE_SOAP" | grep -o "xmlns:dlna"
    # Expected: "xmlns:dlna" (appears in escaped DIDL-Lite as "xmlns:dlna")
    ```

    Kill the background server after tests: `kill $SERVER_PID`.

    If any check fails, fix content_directory.rs to address the failure. Common fixes:
    - Check 4 fails: xml_escape() not being called on the DIDL-Lite string
    - Check 5 fails: `xmlns:dlna` missing from `didl_lite_wrap()` output
    - Check 3 fails with 200: Unknown ObjectID match arm returning empty response instead of soap_fault(701)
  </action>
  <verify>
    All 5 checks produce expected output:
    1. `grep -c "container"` returns >= 4
    2. BrowseMetadata response is HTTP 200 with NumberReturned in body
    3. Unknown ObjectID returns HTTP 500
    4. Result element contains `&lt;DIDL-Lite` (escaped), not raw `<DIDL-Lite`
    5. `xmlns:dlna` appears in response body
  </verify>
  <done>
    All 5 curl checks pass. Phase 5 ContentDirectory SOAP service is fully implemented and curl-verified. DLNA clients can browse the server's media hierarchy.
  </done>
</task>

</tasks>

<verification>
`cargo build` exits 0.
`cargo test` exits 0.
All 5 curl checks pass.
Browse on ObjectID=0 returns SOAP envelope with four escaped DIDL-Lite container elements.
Unknown ObjectID returns HTTP 500 with errorCode 701.
DIDL-Lite is XML-escaped in the Result element.
</verification>

<success_criteria>
- BrowseDirectChildren on "0" returns four containers (Videos, Music, Photos, All Media)
- BrowseMetadata on "0" returns root container with childCount=4
- BrowseMetadata on a media item UUID returns that item's full metadata
- Unknown ObjectID returns HTTP 500 with SOAP fault errorCode 701
- DIDL-Lite XML is correctly escaped inside the Result element (& → &amp;, < → &lt;)
- All four DIDL-Lite namespaces present (including xmlns:dlna)
- dc:title uses file_stem (no extension)
- dc:date present on all item elements
- protocolInfo uses DLNA.ORG_PN when dlna_profile is Some, omits it when None
- Pagination: RequestedCount=0 returns all items
</success_criteria>

<output>
After completion, create `.planning/phases/05-contentdirectory-service/05-04-SUMMARY.md`
</output>
