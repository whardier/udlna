---
phase: 05-contentdirectory-service
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/http/soap.rs
autonomous: true
requirements: [CONT-01, CONT-02, CONT-03, CONT-04, CONT-05, CONT-06, CONT-07, CONT-08]

must_haves:
  truths:
    - "quick-xml and chrono are available as crate dependencies (cargo build succeeds)"
    - "SOAP envelope builder produces correctly-structured SOAP response XML"
    - "SOAP fault builder produces HTTP 500 + UPnP error envelope for error codes 701 and 402"
    - "extract_soap_param correctly extracts Browse parameters from a SOAP body string"
    - "apply_pagination returns all items when RequestedCount=0 (spec requirement)"
    - "build_protocol_info produces correct DLNA string with and without profile name"
    - "container_uuid produces stable deterministic UUIDs for Videos/Music/Photos/All Media"
    - "format_dc_date returns ISO 8601 date string from a filesystem path"
  artifacts:
    - path: "Cargo.toml"
      provides: "quick-xml and chrono dependencies"
      contains: "quick-xml"
    - path: "src/http/soap.rs"
      provides: "All SOAP and DIDL-Lite utility functions"
      min_lines: 80
  key_links:
    - from: "src/http/soap.rs"
      to: "quick_xml::escape::escape"
      via: "XML escaping in DIDL-Lite generation"
      pattern: "quick_xml::escape"
    - from: "src/http/soap.rs"
      to: "crate::media::metadata::build_machine_namespace"
      via: "container UUID derivation"
      pattern: "build_machine_namespace"
---

<objective>
Add quick-xml and chrono crate dependencies, then implement all shared SOAP/DIDL-Lite utility functions in a new `src/http/soap.rs` module. This plan creates the pure-function foundation that the Browse handler and action dispatchers in Plans 03-04 build on.

Purpose: Pure utility functions are the hardest part to get right (escaping, pagination, protocolInfo) and benefit from being written in isolation before the handler wiring. They are also the TDD candidates — Plan 02 will exercise them.

Output: `Cargo.toml` with two new dependencies; `src/http/soap.rs` with all SOAP/DIDL-Lite utility functions pub-exported.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-contentdirectory-service/05-CONTEXT.md
@.planning/phases/05-contentdirectory-service/05-RESEARCH.md
@src/http/mod.rs
@src/http/state.rs
@src/media/library.rs
@src/media/metadata.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quick-xml and chrono to Cargo.toml</name>
  <files>Cargo.toml</files>
  <action>
    Add two new entries under `[dependencies]` in Cargo.toml:

    ```toml
    quick-xml = { version = "0.39", features = ["serialize"] }
    chrono = { version = "0.4", default-features = false, features = ["std"] }
    ```

    Place quick-xml after the existing `axum-extra` line and chrono after quick-xml.
    Do NOT add `serde` features to quick-xml — serde feature is for `serialize` not a separate serde crate add (serde is already in Cargo.toml).

    After editing, run `cargo build` to confirm the workspace compiles cleanly with the new dependencies.
  </action>
  <verify>
    Run: `cargo build 2>&1 | tail -5`
    Expected: Build succeeds with no errors. The quick-xml and chrono crates appear in the compilation output.
  </verify>
  <done>
    `cargo build` exits 0. `Cargo.lock` contains entries for quick-xml 0.39.x and chrono 0.4.x.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement src/http/soap.rs — SOAP utilities and DIDL-Lite helpers</name>
  <files>src/http/soap.rs</files>
  <action>
    Create `src/http/soap.rs` with all shared utility functions used by the ContentDirectory handler. Every function is `pub` — Plan 03 imports them directly.

    **Constants:**
    ```rust
    pub const CDS_NAMESPACE: &str = "urn:schemas-upnp-org:service:ContentDirectory:1";
    pub const DLNA_FLAGS: &str = "01700000000000000000000000000000";

    // Container names — stable strings used for UUIDv5 derivation (CONTEXT.md locked)
    pub const CONTAINER_VIDEOS: &str = "Videos";
    pub const CONTAINER_MUSIC: &str = "Music";
    pub const CONTAINER_PHOTOS: &str = "Photos";
    pub const CONTAINER_ALL_MEDIA: &str = "All Media";
    ```

    **soap_response(action: &str, inner_xml: &str) -> String:**
    Returns a complete SOAP envelope wrapping the inner XML. Service namespace is always CDS_NAMESPACE.
    ```
    <?xml version="1.0" encoding="utf-8"?>
    <s:Envelope xmlns:s="..." s:encodingStyle="...">
      <s:Body>
        <u:{action}Response xmlns:u="{CDS_NAMESPACE}">
          {inner_xml}
        </u:{action}Response>
      </s:Body>
    </s:Envelope>
    ```

    **soap_fault(error_code: u32, error_description: &str) -> (StatusCode, [(HeaderName, &'static str); 1], String):**
    Returns HTTP 500 status + content-type header + SOAP fault body. UPnP mandates HTTP 500 for SOAP faults (RESEARCH.md anti-pattern warning).
    Use axum's `StatusCode::INTERNAL_SERVER_ERROR` and `axum::http::header::CONTENT_TYPE`.
    Fault body uses UPnP error envelope with `<UPnPError xmlns="urn:schemas-upnp-org:control-1-0">`.
    Return as a tuple `(StatusCode, [(CONTENT_TYPE, "text/xml; charset=\"utf-8\"")], String)` that callers can `.into_response()`.

    **extract_soap_param(body: &str, param: &str) -> Option<String>:**
    Simple string-find extraction. Finds `<{param}>` ... `</{param}>` and returns the content.
    Use the approach from RESEARCH.md Pattern 2 Approach A. Handle missing params gracefully (return None).

    **apply_pagination<'a, T>(items: &'a [T], starting_index: u32, requested_count: u32) -> &'a [T]:**
    Implements UPnP pagination semantics:
    - starting_index beyond end → return empty slice
    - requested_count == 0 → return ALL items from starting_index onward (CRITICAL: spec says 0 = all)
    - otherwise → return min(requested_count, available) items
    See RESEARCH.md Pattern 9 for exact logic.

    **build_protocol_info(mime: &'static str, dlna_profile: Option<&'static str>) -> String:**
    Implements CONTEXT.md locked decision for protocolInfo construction:
    - With profile: `http-get:*:{mime}:DLNA.ORG_PN={profile};DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS={DLNA_FLAGS}`
    - Without profile: `http-get:*:{mime}:DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS={DLNA_FLAGS}`
    Use DLNA_FLAGS constant. Never use wildcard `*` as profile fallback.

    **container_uuid(name: &str) -> uuid::Uuid:**
    Uses `crate::media::metadata::build_machine_namespace()` + `uuid::Uuid::new_v5()`.
    Same pattern as `media_item_id()` in Phase 2 — reuses the same machine namespace.

    **format_dc_date(path: &std::path::Path) -> String:**
    Gets file mtime via `std::fs::metadata(path).ok()?.modified().ok()?`, converts to SystemTime.
    Use `chrono::DateTime::<chrono::Utc>::from(mtime)` then `.format("%Y-%m-%d").to_string()`.
    On any error, return `"1970-01-01".to_string()` as fallback (Samsung requires dc:date; fallback is better than missing).

    **build_res_url(headers: &axum::http::HeaderMap, item_id: &uuid::Uuid) -> String:**
    Reads Host header: `headers.get(axum::http::header::HOST).and_then(|v| v.to_str().ok()).unwrap_or("localhost:8200")`.
    Returns `format!("http://{}/media/{}", host, item_id)`.

    **xml_escape(s: &str) -> std::borrow::Cow<str>:**
    Thin wrapper around `quick_xml::escape::escape(s)`. Used for dc:title, res URLs, and any user-provided string embedded in XML.

    Declare all imports at the top. Add `use axum::http::{StatusCode, header};`.
    Do NOT add `#[cfg(test)]` in this file — tests live in Plan 02 (separate TDD plan).
  </action>
  <verify>
    Run: `cargo build 2>&1 | grep -E "^error"`
    Expected: No error lines. All functions compile.

    Also verify soap.rs is wired into the module tree by adding `pub mod soap;` to `src/http/mod.rs` at this step (it will be needed before Plan 03 anyway). Run `cargo build` again after adding the mod declaration.
  </verify>
  <done>
    `cargo build` exits 0 with soap.rs compiled. All 9 public items (2 constants + 7 functions) are accessible as `crate::http::soap::*`.
  </done>
</task>

</tasks>

<verification>
Run `cargo build` — exits 0 with no errors.
Run `cargo test` — all existing tests still pass (no regressions).
Confirm `src/http/soap.rs` exists and `pub mod soap;` is declared in `src/http/mod.rs`.
</verification>

<success_criteria>
- Cargo.toml contains quick-xml 0.39.x and chrono 0.4.x dependencies
- `src/http/soap.rs` exists with all 9 public items implemented
- `cargo build` exits 0
- `cargo test` exits 0 (no regressions)
- soap.rs is declared in mod.rs so it's part of the module tree
</success_criteria>

<output>
After completion, create `.planning/phases/05-contentdirectory-service/05-01-SUMMARY.md`
</output>
