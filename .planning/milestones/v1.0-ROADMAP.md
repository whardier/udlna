# Roadmap: udlna

## Overview

udlna is built bottom-up for testability: foundation and media scanning first (no networking, unit-testable), then HTTP streaming (curl-testable), then device description XML, then ContentDirectory SOAP (curl POST-testable), then SSDP discovery (ties everything together for real DLNA clients), then ConnectionManager (Xbox requirement), and finally server identity and customization polish. Each phase delivers a verifiable capability that the next phase depends on, avoiding the compounding-failure trap where SSDP and SOAP bugs are indistinguishable.

## Phases

**Phase Numbering:**
- Integer phases (1, 2, 3): Planned milestone work
- Decimal phases (2.1, 2.2): Urgent insertions (marked with INSERTED)

Decimal phases appear between their surrounding integers in numeric order.

- [x] **Phase 1: Project Setup & CLI** - Cargo project scaffold, CLI argument parsing, TOML config loading, and MIME type detection (completed 2026-02-22)
- [ ] **Phase 2: Media Scanner & Metadata** - Recursive directory scanning, container header parsing for duration/resolution/bitrate, and shared server state
- [x] **Phase 3: HTTP Server & File Streaming** - TCP listener with hyper, file serving with RFC 7233 Range support, HEAD requests, and DLNA-specific HTTP headers (completed 2026-02-23)
- [x] **Phase 4: Device & Service Description** - UPnP device description XML and SCPD service description documents served over HTTP (completed 2026-02-23)
- [x] **Phase 5: ContentDirectory Service** - SOAP request parsing, DIDL-Lite XML generation with correct namespaces and escaping, Browse actions with pagination, and mandatory stubs (completed 2026-02-23)
- [x] **Phase 6: SSDP Discovery** - UDP multicast listener, M-SEARCH response, NOTIFY alive/byebye, periodic re-advertisement, and graceful Ctrl+C shutdown (completed 2026-02-23)
- [x] **Phase 7: ConnectionManager Service** - GetProtocolInfo, GetCurrentConnectionIDs, and GetCurrentConnectionInfo SOAP stubs required by Xbox (completed 2026-02-23)
- [x] **Phase 8: Server Identity & Customization** - Stable UUID v5 derived from hostname, custom friendly server name via --name flag (completed 2026-02-23)

## Phase Details

### Phase 1: Project Setup & CLI
**Goal**: User can run `udlna --help` and see a working CLI that parses media paths, loads optional TOML config, and resolves flag/config/default precedence
**Depends on**: Nothing (first phase)
**Requirements**: CLI-01, CLI-03, CLI-04, CLI-05, CLI-07
**Success Criteria** (what must be TRUE):
  1. Running `udlna /path/to/media` accepts one or more positional directory arguments without error
  2. Running `udlna --port 9000 /path` accepts the port flag and stores it in configuration
  3. Placing a valid TOML file at `./udlna.toml` causes the server to load those settings; CLI flags override TOML values
  4. The binary correctly identifies video, audio, and image files by extension and silently skips non-media files
  5. Running `udlna` with no arguments and no config file produces a helpful usage message with sensible defaults documented
**Plans**: 2 plans

Plans:
- [ ] 01-01-PLAN.md — Cargo scaffold, CLI Args struct (clap derive), and MIME classification module
- [ ] 01-02-PLAN.md — Config loading (TOML + XDG search), three-layer merge, and main.rs wiring

### Phase 2: Media Scanner & Metadata
**Goal**: Server scans all provided directories at startup and builds an in-memory media library with extracted metadata (duration, resolution, bitrate) ready for all downstream components
**Depends on**: Phase 1
**Requirements**: CLI-02, INDX-01, INDX-02, INDX-03, INDX-04
**Success Criteria** (what must be TRUE):
  1. Server recursively walks all provided media directories and discovers every video, audio, and image file
  2. Each media item has a stable integer ID, file path, file size, and detected MIME type stored in memory
  3. Audio and video files have duration extracted from container headers (MP4 moov atom, MKV EBML, etc.) and stored in UPnP format (HH:MM:SS.mmm)
  4. Video files and images have resolution (WxH) extracted from container/file headers
  5. Each media item has a DLNA profile name assigned where determinable from container/codec metadata, with wildcard fallback for unrecognized formats
**Plans**: 4 plans

Plans:
- [ ] 02-01-PLAN.md — MediaItem/MediaMeta/MediaLibrary data types and Cargo.toml crate dependencies
- [ ] 02-02-PLAN.md — TDD: format_upnp_duration, dlna_profile_for, and UUID helper pure functions
- [ ] 02-03-PLAN.md — extract_metadata() I/O extraction (symphonia/mp4/imagesize) and scanner.rs walkdir traversal
- [ ] 02-04-PLAN.md — Wire scan() into main.rs with Arc<RwLock<MediaLibrary>> and zero-file exit guard

### Phase 3: HTTP Server & File Streaming
**Goal**: Any HTTP client (curl, browser, media player) can stream media files from the server with full seek support via Range requests and all DLNA-required headers
**Depends on**: Phase 2
**Requirements**: STRM-01, STRM-02, STRM-03, STRM-04, STRM-05, STRM-06, STRM-07
**Success Criteria** (what must be TRUE):
  1. `curl http://localhost:8200/media/{id}` returns the correct file with the right Content-Type header matching its MIME type
  2. `curl -I http://localhost:8200/media/{id}` (HEAD request) returns 200 with Content-Length, Accept-Ranges, and DLNA headers but no body
  3. `curl -H "Range: bytes=0-99" http://localhost:8200/media/{id}` returns 206 Partial Content with correct Content-Range header and exactly 100 bytes
  4. All media responses include `Accept-Ranges: bytes`, `transferMode.dlna.org: Streaming`, and `contentFeatures.dlna.org` with DLNA.ORG_OP=01 and DLNA.ORG_FLAGS
  5. DIDL-Lite `<res>` elements (when generated in Phase 5) will have access to `size` attribute from the media library built in Phase 2
**Plans**: 3 plans

Plans:
- [ ] 03-01-PLAN.md — Cargo deps (axum/axum-extra/tower-http/http-range-header/tokio), localhost config flag, AppState, and router scaffold with 501 stubs
- [ ] 03-02-PLAN.md — Media handler: serve_media_get (full GET + RFC 7233 Range) and serve_media_head (DLNA headers, no file open)
- [ ] 03-03-PLAN.md — main.rs async transition, AppState wiring, dual-bind TCP (IPv4 + IPv6) or localhost-only, and end-to-end curl verification

### Phase 4: Device & Service Description
**Goal**: DLNA clients can fetch the UPnP device description and service description documents needed to understand what the server offers
**Depends on**: Phase 3
**Requirements**: DESC-01, DESC-02, DESC-03
**Success Criteria** (what must be TRUE):
  1. `curl http://localhost:8200/device.xml` returns valid XML with `MediaServer:1` device type, both ContentDirectory and ConnectionManager service declarations, and `dlna:X_DLNADOC` element
  2. `curl http://localhost:8200/cds/scpd.xml` returns valid ContentDirectory SCPD XML listing Browse, GetSearchCapabilities, GetSortCapabilities, and GetSystemUpdateID actions with their argument definitions
  3. `curl http://localhost:8200/cms/scpd.xml` returns valid ConnectionManager SCPD XML listing GetProtocolInfo, GetCurrentConnectionIDs, and GetCurrentConnectionInfo actions
**Plans**: 2 plans

Plans:
- [ ] 04-01-PLAN.md — AppState server_uuid, description.rs handlers (device.xml + CDS SCPD + CMS SCPD), router wiring
- [ ] 04-02-PLAN.md — End-to-end curl verification of all three description endpoints

### Phase 5: ContentDirectory Service
**Goal**: DLNA clients can browse the server's media library via SOAP requests and receive correctly formatted DIDL-Lite XML responses with full metadata and DLNA protocol information
**Depends on**: Phase 4
**Requirements**: CONT-01, CONT-02, CONT-03, CONT-04, CONT-05, CONT-06, CONT-07, CONT-08
**Success Criteria** (what must be TRUE):
  1. A SOAP POST to `/cds/control` with Browse(BrowseDirectChildren, ObjectID=0) returns a SOAP envelope containing XML-escaped DIDL-Lite with all media items, each having correct dc:title, upnp:class, and res element with protocolInfo
  2. A SOAP POST with Browse(BrowseMetadata) for a specific item ID returns that item's full metadata including duration, resolution, size, and DLNA profile in protocolInfo
  3. Browse with StartingIndex=5 and RequestedCount=10 returns the correct slice; RequestedCount=0 returns all items from StartingIndex onward; NumberReturned and TotalMatches are accurate
  4. GetSearchCapabilities, GetSortCapabilities, and GetSystemUpdateID SOAP requests each return valid SOAP responses (empty caps for search/sort, integer ID for system update)
  5. DIDL-Lite `<res>` elements include duration (HH:MM:SS.mmm) for audio/video, resolution (WxH) for video/images, size in bytes, and protocolInfo with DLNA.ORG_OP and DLNA.ORG_FLAGS
**Plans**: 4 plans

Plans:
- [ ] 05-01-PLAN.md — Cargo deps (quick-xml, chrono) and src/http/soap.rs with all SOAP/DIDL-Lite utility functions
- [ ] 05-02-PLAN.md — TDD: pure function verification (extract_soap_param, apply_pagination, build_protocol_info, container_uuid, xml_escape)
- [ ] 05-03-PLAN.md — content_directory.rs action dispatch + GetSearchCapabilities/GetSortCapabilities/GetSystemUpdateID + mod.rs wiring
- [ ] 05-04-PLAN.md — Complete Browse handler (BrowseDirectChildren + BrowseMetadata + pagination) and end-to-end curl verification

### Phase 6: SSDP Discovery
**Goal**: DLNA clients on the local network automatically discover the server without any manual configuration; the server disappears cleanly from device lists on shutdown
**Depends on**: Phase 5
**Requirements**: DISC-01, DISC-02, DISC-03, DISC-04, CLI-06
**Success Criteria** (what must be TRUE):
  1. A DLNA client (or gssdp-discover / SSDP tool) sending M-SEARCH to 239.255.255.250:1900 receives a unicast reply with the correct LOCATION URL pointing to `/device.xml`
  2. On startup, the server sends SSDP NOTIFY alive messages 2-3 times (for UDP reliability) so clients already listening discover it immediately
  3. The server re-sends NOTIFY alive every 900 seconds so clients that power on after the server still discover it
  4. Pressing Ctrl+C causes the server to send SSDP NOTIFY byebye before exiting, and the process terminates cleanly with no orphan sockets
  5. A real DLNA client (VLC UPnP browser or similar) can discover the server, browse its media library, and begin streaming a file -- the full end-to-end flow works
**Plans**: 3 plans

Plans:
- [ ] 06-01-PLAN.md — Cargo deps (getifaddrs, tokio signal/time/sync) and src/ssdp/ module (socket.rs, messages.rs, mod.rs)
- [ ] 06-02-PLAN.md — SSDP service task (service.rs) and main.rs restructure with shutdown broadcast and startup sequencing
- [ ] 06-03-PLAN.md — End-to-end SSDP verification (automated M-SEARCH + human checkpoint)

### Phase 7: ConnectionManager Service
**Goal**: Xbox Series X and other strict DLNA clients that require ConnectionManager can query protocol info and connection state without errors
**Depends on**: Phase 6
**Requirements**: CONN-01, CONN-02, CONN-03
**Success Criteria** (what must be TRUE):
  1. A SOAP POST to `/cms/control` with GetProtocolInfo returns the list of supported MIME types as source protocol info entries
  2. GetCurrentConnectionIDs returns a SOAP response with connection ID "0"
  3. GetCurrentConnectionInfo returns a SOAP response with default connection values (RcsID=-1, AVTransportID=-1, Status=OK)
**Plans**: 1 plan

Plans:
- [ ] 07-01-PLAN.md — CMS handler (src/cms/mod.rs), soap_response_ns() extension, SUPPORTED_MIMES const, router wiring, and curl verification

### Phase 8: Server Identity & Customization
**Goal**: Server maintains a consistent identity across restarts and users can customize how it appears on TV device lists
**Depends on**: Phase 7
**Requirements**: CLI-08, DISC-05
**Success Criteria** (what must be TRUE):
  1. Server generates a UUID v5 from hostname + server name using the DNS namespace; the same UUID appears in device.xml and SSDP messages across multiple restarts without any state file
  2. Running `udlna --name "Living Room Server" /media` causes "Living Room Server" to appear as the friendly name on Samsung TV and Xbox device lists
  3. When no --name flag is provided, a sensible default name (e.g., "udlna") is used
**Plans**: 1 plan

Plans:
- [ ] 08-01-PLAN.md — Add hostname crate, UUID v5 from hostname, server_name in AppState, friendlyName wired, SsdpConfig updated, compiler warnings fixed

## Progress

**Execution Order:**
Phases execute in numeric order: 1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7 -> 8

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Project Setup & CLI | 2/2 | Complete    | 2026-02-22 |
| 2. Media Scanner & Metadata | 4/4 | Complete | 2026-02-22 |
| 3. HTTP Server & File Streaming | 3/3 | Complete   | 2026-02-23 |
| 4. Device & Service Description | 2/2 | Complete   | 2026-02-23 |
| 5. ContentDirectory Service | 4/4 | Complete   | 2026-02-23 |
| 6. SSDP Discovery | 3/3 | Complete   | 2026-02-23 |
| 7. ConnectionManager Service | 1/1 | Complete   | 2026-02-23 |
| 8. Server Identity & Customization | 1/1 | Complete   | 2026-02-23 |
